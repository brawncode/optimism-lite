name: System Monitor Log (every 20 min)

on:
  schedule:
    - cron: "*/20 * * * *"
  workflow_dispatch:

concurrency:
  group: sys-monitor
  cancel-in-progress: true

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Random delay
        run: |
          # –∑–∞–¥–µ—Ä–∂–∫–∞ 0‚Äì360 —Å–µ–∫ (–¥–æ 6 –º–∏–Ω—É—Ç)
          DELAY=$((RANDOM % 360))
          echo "Sleeping for $DELAY seconds..."
          sleep $DELAY

      - name: Write log entry (always)
        run: |
          mkdir -p logs

          DAY=$(date -u +"%Y-%m-%d")
          FILE="logs/${DAY}.log"

          # —Å–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          touch "$FILE"

          TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          TASK=$((100 + RANDOM % 900))
          LATENCY=$((20 + RANDOM % 180))
          UPTIME=$(awk -v r=$RANDOM 'BEGIN { printf("%.3f", 99.0 + (r % 900)/10000) }')

          LOG="[${TIME}] Task #${TASK} COMPLETED ‚Äî uptime=${UPTIME}% ‚Äî latency=${LATENCY}ms"
          echo "$LOG" >> "$FILE"

          echo "Written: $LOG"

      - name: Update README with today's last 5 logs
        run: |
          DAY=$(date -u +"%Y-%m-%d")
          FILE="logs/${DAY}.log"

          echo "### üõ†Ô∏è System Monitor ‚Äî ${DAY}" > new_section.txt
          echo "" >> new_section.txt

          if [ -f "$FILE" ]; then
            tail -n 5 "$FILE" | tac | while read -r line; do
              echo "- \`${line}\`" >> new_section.txt
            done
          else
            echo "_No events yet today._" >> new_section.txt
          fi

          echo "" >> new_section.txt

          # —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–µ–∫—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞
          if grep -q "### üõ†Ô∏è System Monitor" README.md; then
            sed -i '/### üõ†Ô∏è System Monitor/,$d' README.md
          fi

          cat new_section.txt >> README.md
          rm -f new_section.txt

      - name: Commit and push changes
        run: |
          git config user.name "brawncode"
          git config user.email "nftdropped@gmail.com"

          git add README.md logs/
          git commit -m "System log update: $(date -u)" || echo "No changes"

          # –≤–∞–∂–Ω—ã–π —Ñ–∏–∫—Å ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É 'fetch first'
          git pull --rebase --autostash origin main

          git push
